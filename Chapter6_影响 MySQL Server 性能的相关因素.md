# 影响 MySQL Server 性能的相关因素


1. 商业需求对性能的影响

    * 不合理需求造成资源投入产出比过低

        举例： 统计论坛帖子总数 且需要实时更新。 （该实时更新要求即为不合理需求）

    * 无用功能堆积使系统过度复杂影响整体性能

        很多时候，为系统增加某个功能可能并不需要花费太多的成本，而要想将一个已经运行了一段时间的功能从原有系统中撤下来却是非常困难的。

2. 系统架构及实现对性能的影响

    1. 我们数据库中存放的数据都是适合在数据库中存放的吗？

        以下几类数据都是不适合在数据库中存放的：

        * 二进制多媒体数据

        * 流水队列数据

            数据库为了保证事务的安全性（支持事务的存储引擎）以及可恢复性，都是需要记录所有变更的日志信息的。而流水队列数据的用途就决定了存放这种数据的表中的数据会不断的被INSERT，UPDATE 和DELETE，而每一个操作都会生成与之对应的日志信息。 在MySQL中，如果是支持事务的存储引擎，这个日志的产生量更是要翻倍。

        * 超大文本数据

            需要存储更长的文本数据到一个字段，我们就必须使用TEXT 类型（最大可存放64KB）的字段，甚至是更大的LONGTEXT 类型（最大4GB）。而TEXT 类型数据的处理性能要远比VARCHAR 类型数据的处理性能低下很多.超大文本数据存放在数据库中不仅会带来性能低下的问题，还会带来空间占用的浪费问题。

    2. 是否合理的利用了应用层Cache 机制？

        对于Web 应用，活跃数据的数据量总是不会特别的大，有些活跃数据更是很少变化。对于这类数据，我们是否有必要每次需要的时候都到数据库中去查询呢？如果我们能够将变化相对较少的部分活跃数据通过应用层的Cache 机制Cache 到内存中，对性能的提升肯定是成数量级的，而且由于是活跃数据，对系统整体的性能影响也会很大。

        什么样的数据适合通过Cache 技术来提高系统性能：

        * 系统各种配置及规则数据；

        * 活跃用户的基本信息数据；

        * 活跃用户的个性化定制信息数据；

        * 准实时的统计信息数据；

        * 其他一些访问频繁但变更较少的数据；

    3. 我们的数据层实现都是最精简的吗？

        过渡弱化SQL 语句的功能造成的资源浪费

        过度依赖数据库SQL 语句的功能造成数据库操作效率低下

        重复执行相同的SQL 造成资源浪费


    4. 较为常见的架构设计实现不当带来的性能问题和资源浪费情况

        1、Cache 系统的不合理利用导致Cache 命中率低下造成数据库访问量的增加，同时也浪费了Cache系统的硬件资源投入；

        2、过度依赖面向对象思想

        3、对可扩展性的过渡追求，促使系统设计的时候将对象拆得过于离散，造成系统中大量的复杂Join语句，而MySQL Server 在各数据库系统中的主要优势在于处理简单逻辑的查询，这与其锁定的机制也有较大关系；
        
        4、对数据库的过渡依赖，将大量更适合存放于文件系统中的数据存入了数据库中，造成数据库资源的浪费，影响到系统的整体性能，如各种日志信息；

        5、过度理想化系统的用户体验，使大量非核心业务消耗过多的资源，如大量不需要实时更新的数据做了实时统计计算。

5. Query 语句对系统性能的影响

    使用profile进行分析

        > set profiling = 1;

6. Schema 设计对系统的性能影响

    对表的设计，考虑后续常用的SQL语句而对表进行优化。

7. 硬件环境对系统性能的影响

    * 数据库主机是存取数据的地方，那么其IO 操作自然不会少，所以数据库主机的IO 性能肯定是需要最优先考虑的一个因素

        一类是每秒可提供的IO 访问次数，也就是我们常说的IOPS 数量，还有一种就是每秒的IO 总流量，也就是我们常说的IO 吞吐量

    * 数据库主机的CPU 处理能力也不能忽视 

    * 数据库主机的网络设备的性能也可能会成为系统的瓶颈

    各种类型简单分析：

    1. 典型OLTP 应用系统 (On-Line Transaction Processing联机事务处理过程(OLTP))

        特点是并发量大，整体数据量比较多，但每次访问的数据比较少，且访问的数据比较离散，活跃数据占总体数据的比例不是太大。对于这类系统的数据库实际上是最难维护，最难以优化的，对主机整体性能要求也是最高的。因为他不仅访问量很高，数据量也不小。

        针对上面的这些特点和分析，我们可以对OLTP 的得出一个大致的方向。

        * 虽然系统总体数据量较大，但是系统活跃数据在数据总量中所占的比例不大，那么我们可以通过扩大内存容量来尽可能多的将活跃数据cache 到内存中；

        * 虽然IO 访问非常频繁，但是每次访问的数据量较少且很离散，那么我们对磁盘存储的要求是IOPS 表现要很好，吞吐量是次要因素；

        * 并发量很高，CPU 每秒所要处理的请求自然也就很多，所以CPU 处理能力需要比较强劲；虽然与客户端的每次交互的数据量并不是特别大，但是网络交互非常频繁，所以主机与客户端交互的网络设备对流量能力也要求不能太弱。

    2. 典型OLAP 应用系统

        用于数据分析的OLAP 系统的主要特点就是数据量非常大，并发访问不多，但每次访问所需要检索的数据量都比较多，而且数据访问相对较为集中，没有太明显的活跃数据概念。

        * 数据量非常大，所以磁盘存储系统的单位容量需要尽量大一些

        * 单次访问数据量较大，而且访问数据比较集中，那么对IO 系统的性能要求是需要有尽可能大的每秒IO 吞吐量，所以应该选用每秒吞吐量尽可能大的磁盘

        * 虽然IO 性能要求也比较高，但是并发请求较少，所以CPU 处理能力较难成为性能瓶颈，所以CPU 处理能力没有太苛刻的要求

        * 虽然每次请求的访问量很大，但是执行过程中的数据大都不会返回给客户端，最终返回给客户端的数据量都较小，所以和客户端交互的网络设备要求并不是太高

        由于OLAP 系统由于其每次运算过程较长，可以很好的并行化，所以一般的OLAP 系统都是由多台主机构成的一个集群，而集群中主机与主机之间的数据交互量一般来说都是非常大的，所以在集群中主机之间的网络设备要求很高。

    3. 除了以上两个典型应用之外，还有一类比较特殊的应用系统，他们的数据量不是特别大，但是访问请求及其频繁，而且大部分是读请求。

        比如基于数据库的DNS 服务就是这样类型的服务。

        * 虽然数据量小，但是访问极其频繁，所以可以通过较大的内存来cache 住大部分的数据，这能够保证非常高的命中率，

        * 磁盘IO 量比较小，所以磁盘也不需要特别高性能的；

        * 并发请求非常频繁，比需要较强的CPU 处理能力才能处理；
        
        * 虽然应用与数据库交互量非常大，但是每次交互数据较少，总体流量虽然也会较大，但是一般来说普通的千兆网卡已经足够了。

数据库应用系统的优化真正能带来最大收益的就是商业需求和系统架构及业务实现的优化，然后是数据库Schema 设计的优化，然后才是Query 语句的优化，最后才是数据库管理软件自身的一些优化。


在整个系统的性能优化中，如果按照百分比来划分上面几个层面的优化带来的性能收益，可以得出大概如下的数据：

* 需求和架构及业务实现优化：55%

* Query 语句的优化：30%

* 数据库自身的优化：15%

可以通过下面来简单的概括数据库应用系统的性能优化：

* 商业需求合理化

* 系统架构最优化

* 逻辑实现精简化

* 硬件设施理性化